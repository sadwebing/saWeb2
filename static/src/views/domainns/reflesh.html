
<title>域名缓存</title>

<div class="layui-card layadmin-header">
  <div class="layui-breadcrumb" lay-filter="breadcrumb-tg">
    <a lay-href="">主页</a>
    <a><cite>域名缓存</cite></a>
  </div>
</div>

<div class="layui-fluid">
  <div class="layui-row layui-col-space15">
    <div class="layui-col-md12">
      <div class="layui-card">
        <div class="layui-tab">
            <ul class="layui-tab-title">
              <li class="layui-this">CDN 账号</li>
              <li>项目</li>
            </ul>
            <div class="layui-tab-content">
              <div class="layui-tab-item layui-show">
                  <div class="layui-card-body">
                      <div class="layui-form" lay-filter="component-form-element">
                        <form class="layui-row layui-col-space10 layui-form-item">
            
                          <script type="text/html" template lay-url="/domainns/reflesh" lay-done="layui.data.done(d);">
            
                              <div class="layui-col-lg6">
                                <label class="layui-form-label">CDN</label>
                                <div class="layui-input-block">
                                    <select name="cdn_account" lay-verify="cdn_account" xm-select="cdn_account" xm-select-radio xm-select-search="" xm-select-search-type="dl" xm-select-skin="warm">
                                        <option value=""></option>
                                        {{ layui.setter.reflesh_project = d.data }}
                                        {{#  for (var index in d.data.cdn){ }}
                                        {{# var cdn = d.data.cdn[index]}}
                                        <option value="{{ cdn.id }}">{{ cdn.account }}</option>
                                        {{#  }; }}
                                      </select>
                                </div>
                              </div>
            
                              <div class="layui-col-lg6">
                                <label class="layui-form-label">域名</label>
                                <div class="layui-input-block">
                                  <select name="cdn_domain" lay-verify="cdn_domain" xm-select="cdn_domain" xm-select-skin="default" xm-select-show-count=3 xm-select-height="50px" xm-select-search="" xm-select-search-type="dl">
                                  </select>
                                </div>
                              </div>
            
                          </script>
                        </from>
                        <div class="layui-form-item">
                          <label class="layui-form-label">URI</label>
                          <div class="layui-input-block">
                            <textarea name="text" lay-verify="text" placeholder="URI[/test/test.js]，每行一条" class="layui-textarea" style="height: 180px;" required></textarea>
                          </div>
                        </div>
                        <div class="layui-form-item">
                          <div class="layui-input-block">
                            <button name="telegramSendButton" id="telegramSendButton" class="layui-btn" lay-submit lay-filter="component-form-element" data-type="loading1">清理</button>
                            <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                          </div>
                        </div>
                      </div>
                    </div>
              </div>
              <div class="layui-tab-item">内容2</div>
            </div>
          </div>

      </div>
    </div>
  </div>
</div>

<script>
layui.data.done = function(d){
  layui.form.render(null, 'component-form-element');
  layui.element.render('breadcrumb', 'breadcrumb-tg');
  layui.formSelects.render('cdn_account', {
    template: function(name, value, selected, disabled){
      for (var index in layui.setter.reflesh_project.cdn) {
        var cdn = layui.setter.reflesh_project.cdn[index];
        if (value.value == cdn.id){
          return value.name + '<span style="position: absolute; right: 0; color: #A0A0A0; font-size: 12px;">' + cdn.name + '</span>';
        }
      }
    }
  });
  layui.formSelects.render('cdn_domain');
  layer.close(loading1_iii);

  // 监听 cdn_account
  layui.formSelects.on('cdn_account', (id, vals, val, isAdd, isDisabled)=>{
      // 将新的数据加入 cdn_domain
      var arr = new Array();
      for (index in vals){
        var id = vals[index].value;
        for (index2 in layui.setter.reflesh_project.cdn){
          var cdn_acc = layui.setter.reflesh_project.cdn[index2];

          if (id == cdn_acc.id){
            arr.push({"name": vals[index].name, "type": "optgroup"})
            for (index3 in cdn_acc.domain){
              var domain = cdn_acc.domain[index3];

              if (cdn_acc.name == "aws"){ // 如果是aws 域名，进行特殊处理
                arr.push({"name": domain.Id+": "+domain.name.join(", "), "value": domain['Id']})
              }else {
                if (domain.ssl === 1){
                  arr.push({"name": "https://"+domain.name , "value": "https://"+domain.name})
                }else {
                  arr.push({"name": "http://"+domain.name , "value": "http://"+domain.name})
                }
                
              }
            }
          }
        }
      };
      //local模式
      layui.formSelects.data('cdn_domain', 'local', {
          arr: arr
      });
    }, true);
};

layui.use(['admin', 'form', 'formSelects', 'upload'], function(){
  var $ = layui.$
  ,admin = layui.admin
  ,element = layui.element
  ,form = layui.form
  ,upload = layui.upload
  ,formSelects = layui.formSelects;

  // 等待的弹层
  function loading1(){
    loading1_iii = layer.load(2, {
      shade: [0.1,'#fff']
    });
  };

  loading1.call(this); // 打开 等待的弹层

  // 验证表单
  // form.verify({
  //     cdn_account: function(value){
  //       if(value.length == 0){
  //         return (content='请选择telegram 群组', offset="top");
  //       }
  //     }
  //     // ,text: function(value){
  //     //   if(value.length == 0){
  //     //     return '信息不能为空';
  //     //   }
  //     // }
  //   });

  // admin 请求
  function sendpicture(data){
    admin.req({
      url: '/detect/telegram/sendgroupmessage' //实际使用请改成服务端真实接口code == 1001
      ,method: "post" 
      ,data: data
      ,processData: false
      ,contentType: false
      // ,async: false
      ,done: function(res){
        // 发送成功的提示
        layer.msg(res.msg, {
          offset: '15px'
          ,icon: 1
          ,time: 1000
        });
        // layer.close(loading1_iii); // 关闭 等待的弹层
      },success:function(res){
        if (res.code == 1001){ // 登陆失效
          layer.msg(res.msg, {
            offset: '15px'
            ,icon: 1
            ,time: 1000
          })
        };
        // layer.close(loading1_iii);
      }
      
    });
  };

  // 提交表单
  form.on('submit(component-form-element)', function(data){
    var type = $(this).data('type');
    
    // 验证表单中的tg群组 
    if (data.field.cdn_account.length == 0){
      layer.msg('请选择telegram 群组', {
          offset: '15px'
          ,shift: 6
          ,icon: 5
          ,time: 1000
      });
      return false;
    }

    loading1.call(this); // 打开 等待的弹层

    // 将表单数据 放入图片请求里面
    var postData = new FormData();
    postData.append('cdn_account', data.field.cdn_account);
    postData.append('cdn_domain', data.field.cdn_domain);
    postData.append('text', data.field.text);

    var fileNum = 0;
    if (uploadListIns.config.files){
      // uploadListIns.config.data = data.field;
      // uploadListIns.upload();
      $.each(uploadListIns.config.files, function (index, item) { 
        postData.append('files[]', item, item.name);
        fileNum = fileNum + 1;
        // sendpicture(postData);
      });

      send_text = false;
    }else {
      send_text = true;
      // console.log('no pics');
    };

    // 如果不是必须发送信息，取消等待的弹层
    // if (send_text == false && data.field.text.length == 0){
    //     layer.close(loading1_iii);
    //     return false;
    //   };

    // 验证表单中的信息
    if (data.field.text.replace(/\s+/g, "").length == 0 && fileNum == 0){
      layer.msg('信息不能为空', {
          offset: '15px'
          ,shift: 6
          ,icon: 5
          ,time: 1000
      });
      layer.close(loading1_iii);
      return false;
    }

    admin.req({
      url: '/detect/telegram/sendgroupmessage' //实际使用请改成服务端真实接口code == 1001
      ,method: "post" 
      ,data: postData
      ,processData: false
      ,contentType: false
      ,done: function(res){
        // 发送成功的提示
        layer.msg(res.msg, {
          offset: '15px'
          ,icon: 1
          ,time: 1000
        });
        layer.close(loading1_iii); // 关闭 等待的弹层
      },success:function(res){
        if (res.code == 1001){ // 登陆失效
          layer.msg(res.msg, {
            offset: '15px'
            ,icon: 1
            ,time: 1000
          })
        };
        layer.close(loading1_iii);
      }
      
    });

    return false;
  });
});
</script>